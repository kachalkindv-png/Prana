<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Пранаяма 1-4-2 — Бинауральный</title>
<style>
  :root {
    --bg: #0b0b0b;
    --fg: #f6e7b4;
    --muted: #b7a97a;
    --accent: #ffd76a;
    --inh: #7fd88a;
    --hold: #ffd76a;
    --exh: #85b7ff;
  }
  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: -apple-system,Segoe UI,Roboto,Inter,Arial;
  }
  .wrap {
    min-height: 100%;
    display: flex;
    flex-direction: column;
    gap: 14px;
    padding: 16px;
  }
  header {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: center;
  }
  input, select, button {
    padding: 6px 10px;
    font-size: 16px;
  }
  .phase {
    text-align: center;
    font-size: 2em;
    margin-top: 20px;
  }
  .timer {
    text-align: center;
    font-size: 4em;
    margin-top: 10px;
    font-variant-numeric: tabular-nums;
  }
  .block-info {
    text-align: center;
    font-size: 1em;
    margin-top: 4px;
    color: var(--muted);
  }
</style>
</head>
<body>
<div class="wrap">
<header>
  <label>Вдох (сек): <input type="number" id="inhale" value="10"></label>
  <label>Коэффициенты: 1-4-2</label>
  <label>Длительность блока (мин): <input type="number" id="blockMinutes" value="10"></label>
  <label>Частота бинаурал (Гц): <input type="number" step="0.1" id="binauralFreq" value="4"></label>
  <label>Нейтрал дыханий: <input type="number" id="neutralBreaths" value="0"></label>
  <button id="startBtn">Старт</button>
  <button id="stopBtn">Стоп</button>
</header>
<div class="phase" id="phaseName">Ожидание</div>
<div class="timer" id="timeLeft">00:00</div>
<div class="block-info" id="blockInfo"></div>
</div>
<script>
let audioCtx, oscLeft, oscRight, gainNode;
let binauralFreq = 4; // по умолчанию 4 Гц
let carrierFreq = 200; // несущая частота (Гц)

function startBinaural(freq) {
  binauralFreq = freq;
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let merger = audioCtx.createChannelMerger(2);
    oscLeft = audioCtx.createOscillator();
    oscRight = audioCtx.createOscillator();
    gainNode = audioCtx.createGain();
    gainNode.gain.value = 0.2; // громкость

    oscLeft.type = 'sine';
    oscRight.type = 'sine';

    oscLeft.frequency.value = carrierFreq - binauralFreq / 2;
    oscRight.frequency.value = carrierFreq + binauralFreq / 2;

    oscLeft.connect(merger, 0, 0); // левый канал
    oscRight.connect(merger, 0, 1); // правый канал

    merger.connect(gainNode).connect(audioCtx.destination);

    oscLeft.start();
    oscRight.start();
  } else {
    oscLeft.frequency.value = carrierFreq - binauralFreq / 2;
    oscRight.frequency.value = carrierFreq + binauralFreq / 2;
  }
}

function stopBinaural() {
  if (audioCtx) {
    audioCtx.close();
    audioCtx = null;
    oscLeft = null;
    oscRight = null;
  }
}
</script>
<script>
// ------------ УТИЛЫ ------------
const $ = (id) => document.getElementById(id);
function pad(n){ n=Math.max(0,Math.ceil(n)); const m=String(Math.floor(n/60)).padStart(2,'0'); const s=String(n%60).padStart(2,'0'); return `${m}:${s}`; }

// ------------ ЭЛЕМЕНТЫ UI ------------
const phaseName = $('phaseName');
const timeLeft  = $('timeLeft');
const blockInfo = $('blockInfo');
const startBtn  = $('startBtn');
const stopBtn   = $('stopBtn');

const inhaleInput   = $('inhale');
const blockMinInput = $('blockMinutes');
const binauralInput = $('binauralFreq');
const neutralCountInput = $('neutralBreaths');

// Добавим "расширенные" настройки поверх шапки через JS, чтобы не править разметку из Ч.1:
const header = document.querySelector('header');

const advanced = document.createElement('div');
advanced.style.display='flex';
advanced.style.flexWrap='wrap';
advanced.style.gap='8px';
advanced.style.alignItems='center';
advanced.style.justifyContent='center';
advanced.style.marginTop='6px';
advanced.innerHTML = `
  <label><input type="checkbox" id="useBatch"> Пачка 2×11 + 1×12</label>
  <label>Мин/Циклы:
    <select id="modeSelect">
      <option value="minutes" selected>По минутам</option>
      <option value="cycles">По циклам</option>
    </select>
  </label>
  <label>Циклов в блоке: <input type="number" id="blockCycles" value="9"></label>
`;
header.appendChild(advanced);

const useBatch   = $('useBatch');
const modeSelect = $('modeSelect');
const blockCycles= $('blockCycles');

// ------------ НАСТРОЙКИ ПО УМОЛЧАНИЮ ------------
let NEUTRAL_IN = 6;   // сек на вдох в нейтрале
let NEUTRAL_OUT= 6;   // сек на выдох в нейтрале

// ------------ АУДИО-СИГНАЛЫ (мягкие) ------------
function cue(name){
  try{
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='sine'; o.connect(g); g.connect(audioCtx.destination);
    const t=audioCtx.currentTime;
    if(name==='Вдох'){ o.frequency.setValueAtTime(420,t); }
    else if(name==='Задержка'){ o.frequency.setValueAtTime(660,t); }
    else if(name==='Выдох'){ o.frequency.setValueAtTime(360,t); }
    else { o.frequency.setValueAtTime(520,t); }
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.15,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.18);
    o.start(t); o.stop(t+0.22);
  }catch(e){}
}
function haptic(){
  if('vibrate' in navigator){ navigator.vibrate(20); }
}

// ------------ МАШИНА СОСТОЯНИЙ ------------
let running=false, paused=false, timerId=null;
let phase = 'Готов';     // 'Вдох' | 'Задержка' | 'Выдох' | 'Нейтрал вдох' | 'Нейтрал выдох' | ...
let phaseSecLeft = 0;

let blockBudgetSec = 0;  // если minutes-режим
let blockCyclesLeft = 0; // если cycles-режим
let cyclesDone = 0;

let pattern = [];        // массив вдохов в сек (11,11,12) или [X] для обычного дыхания
let pattPos = 0;

// ----------- ВСПОМОГАТЕЛЬНЫЕ РАСЧЁТЫ -----------
function makePattern(){
  if(useBatch.checked){
    return [11,11,12]; // 2×11 + 1×12
  }else{
    const inh = +inhaleInput.value || 10;
    return [inh];
  }
}
function currentInhale(){
  return pattern[pattPos % pattern.length];
}
function cycleDurFromInhale(inh){ return inh + inh*4 + inh*2; } // 1-4-2
function setPhase(name, sec){
  phase = name;
  phaseSecLeft = sec;
  phaseName.textContent = name;
  timeLeft.textContent = pad(sec);
  cue(name); haptic();
}
function nextPatternPos(){
  pattPos = (pattPos + 1) % pattern.length;
}

// ----------- ПЕРЕКЛЮЧЕНИЕ ФАЗ -----------
function startCycle(){
  const inh = currentInhale();
  setPhase('Вдох', inh);
}
function advancePhase(){
  const inh = currentInhale();
  if(phase==='Вдох'){
    setPhase('Задержка', inh*4);
  }else if(phase==='Задержка'){
    setPhase('Выдох', inh*2);
  }else if(phase==='Выдох'){
    // цикл завершён
    cyclesDone += 1;
    // Если minutes-режим: проверяем, исчерпали ли бюджет времени
    if(modeSelect.value==='minutes' && blockBudgetSec<=0){
      // завершаем блок на границе цикла -> нейтрал (если есть) -> стоп
      startNeutralOrFinish();
      return;
    }
    // Если cycles-режим: уменьшаем счётчик циклов
    if(modeSelect.value==='cycles'){
      blockCyclesLeft -= 1;
      if(blockCyclesLeft<=0){
        startNeutralOrFinish();
        return;
      }
    }
    // следующий цикл по паттерну
    nextPatternPos();
    startCycle();
  }else if(phase==='Нейтрал вдох'){
    setPhase('Нейтрал выдох', NEUTRAL_OUT);
  }else if(phase==='Нейтрал выдох'){
    neutralLeft -= 1;
    if(neutralLeft<=0){ finishBlock(); }
    else setPhase('Нейтрал вдох', NEUTRAL_IN);
  }
}

let neutralLeft = 0;
function startNeutralOrFinish(){
  const n = +neutralCountInput.value || 0;
  if(n>0){
    neutralLeft = n;
    setPhase('Нейтрал вдох', NEUTRAL_IN);
  }else{
    finishBlock();
  }
}

// ----------- ТИК -----------
function tick(){
  if(!running) return;
  phaseSecLeft -= 1;

  // уменьшение «по минутам» только на фазах пранаямы (не нейтрал)
  if(modeSelect.value==='minutes' && (phase==='Вдох'||phase==='Задержка'||phase==='Выдох')){
    blockBudgetSec = Math.max(0, blockBudgetSec - 1);
  }

  timeLeft.textContent = pad(phaseSecLeft);

  if(phaseSecLeft<=0){
    advancePhase();
  }

  timerId = setTimeout(tick, 1000);
}

// ----------- БЛОК: СТАРТ/ФИНИШ -----------
function startBlock(){
  running = true;
  cyclesDone = 0;
  pattPos = 0;
  pattern = makePattern();

  // minutes vs cycles
  if(modeSelect.value==='minutes'){
    blockBudgetSec = Math.round((+blockMinInput.value || 10) * 60);
    blockCyclesLeft = 0;
  }else{
    blockCyclesLeft = Math.max(1, (+blockCycles.value || 1));
    blockBudgetSec = 0;
  }

  // Инфо-блок
  const pattText = useBatch.checked ? 'Пачка 2×11+1×12' : `Вдох ${pattern[0]}с (1‑4‑2)`;
  blockInfo.textContent =
    (modeSelect.value==='minutes'
      ? `Режим: минуты · Осталось ${pad(blockBudgetSec)} · ${pattText}`
      : `Режим: циклы · Осталось ${blockCyclesLeft} · ${pattText}`);

  // Запуск постоянного бинаурального ритма
  const freq = +binauralInput.value || 4;
  try{
    if(!audioCtx) startBinaural(freq); else startBinaural(freq);
  }catch(e){}

  startCycle();
  clearTimeout(timerId); timerId = setTimeout(tick, 1000);
}

function finishBlock(){
  running=false;
  clearTimeout(timerId);
  timeLeft.textContent='00:00';
  phaseName.textContent='Готово';
  blockInfo.textContent = `Циклов выполнено: ${cyclesDone}`;
  try{ stopBinaural(); }catch(e){}
}

// ----------- КНОПКИ -----------
startBtn.addEventListener('click', ()=>{
  if(running) return;
  // iOS требует пользовательское действие перед аудио
  if(!audioCtx){
    startBinaural(+binauralInput.value || 4);
    stopBinaural();
  }
  startBlock();
});
stopBtn.addEventListener('click', ()=>{
  if(!running) return;
  finishBlock();
});
</script>
<script>
// Небольшое удобство: если меняешь настройки до старта — показываем подсказку
[ inhaleInput, blockMinInput, binauralInput, neutralCountInput, useBatch, modeSelect, blockCycles ].forEach(el=>{
  el.addEventListener('change', ()=>{
    if(!running){
      const pattText = useBatch.checked ? 'Пачка 2×11+1×12' : `Вдох ${(+inhaleInput.value||10)}с (1‑4‑2)`;
      const modeText = (modeSelect.value==='minutes')
        ? `Режим: минуты · ${(+blockMinInput.value||10)} мин · ${pattText}`
        : `Режим: циклы · ${(+blockCycles.value||9)} · ${pattText}`;
      blockInfo.textContent = `Готов к старту · ${modeText} · Бинаурал: ${(+binauralInput.value||4)} Гц`;
    }
  });
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Пранаяма 1‑4‑2 — Разминка/Работа/Челлендж/Тест</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#000;
    --fg:#f6e7b4;
    --muted:#b7a97a;
    --accent:#ffd76a;
    --accent-dim:#5a481a;
    --ring:#ffec9c;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:18px 16px 26px;gap:14px}
  .title{font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-size:14px;text-align:center}
  .block{font-size:20px;color:var(--fg);text-align:center}
  .count{font-size:80px;line-height:1;font-weight:900;text-shadow:0 0 24px rgba(255,215,106,.25);}
  .phase{font-size:16px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted)}
  .bars{width:100%;max-width:760px;display:flex;flex-direction:column;gap:10px}
  .bar{height:10px;background:linear-gradient(90deg, rgba(255,215,106,.15), rgba(255,215,106,.05));border-radius:999px;border:1px solid rgba(255,215,106,.25);overflow:hidden}
  .fill{height:100%;width:0%;background:linear-gradient(90deg, var(--accent), #f5c542);box-shadow:0 0 12px rgba(255,215,106,.35) inset}
  .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
  button{appearance:none;border:1px solid var(--accent-dim);background:transparent;color:var(--fg);
          padding:12px 16px;border-radius:14px;font-weight:800;letter-spacing:.02em}
  button.primary{background:linear-gradient(180deg,#2a220b,#151006);border-color:#3a2f0f;box-shadow:inset 0 1px 0 rgba(255,255,255,.06)}
  button:disabled{opacity:.45}
  .tog{display:flex;gap:8px;align-items:center;color:var(--muted)}
  input[type=checkbox]{width:22px;height:22px;accent-color:#f1cf62}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .hint{font-size:12px;color:var(--muted);text-align:center;opacity:.85}
  .pill{display:inline-block;border:1px solid var(--accent-dim);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .kpis .pill b{color:var(--fg)}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">Пранаяма 1‑4‑2</div>
  <div class="block" id="blockName">—</div>
  <div class="count mono" id="count">00:00</div>
  <div class="phase" id="phase">Готов</div>

  <div class="bars">
    <div class="bar" aria-label="Прогресс фазы"><div class="fill" id="phaseFill"></div></div>
    <div class="bar" aria-label="Прогресс блока"><div class="fill" id="blockFill"></div></div>
    <div class="bar" aria-label="Прогресс всей сессии"><div class="fill" id="totalFill"></div></div>
  </div>

  <div class="kpis">
    <span class="pill">В блоке осталось: <b id="blockRemain">—</b></span>
    <span class="pill">До конца сессии: <b id="totalRemain">—</b></span>
    <span class="pill">Циклов завершено: <b id="cyclesDone">0</b></span>
  </div>

  <div class="row">
    <button id="startBtn" class="primary">▶️ Старт</button>
    <button id="pauseBtn" disabled>⏸ Пауза</button>
    <button id="resetBtn" disabled>⟲ Сброс</button>
    <label class="tog"><input id="voiceOn" type="checkbox" checked> Голос</label>
    <label class="tog"><input id="tonesOn" type="checkbox" checked> Тоны</label>
    <label class="tog"><input id="vibeOn"  type="checkbox" checked> Вибро</label>
  </div>

  <div class="hint">Совет: на iPhone нажми «Старт», чтобы разрешить звук. Постараюсь удерживать экран от засыпания.</div>
</div>

<script>
const PLAN = [
  { kind:"duration",   name:"Разминка", minutes:10, inhale:10, hold:40, exhale:20, announce:"Разминка. Вдох десять секунд." },
  { kind:"patternDur", name:"Работа",   minutes:10, pattern:[
      {inhale:11, hold:44, exhale:22},
      {inhale:11, hold:44, exhale:22},
      {inhale:12, hold:48, exhale:24},
    ], announce:"Работа. Чередуем два цикла одиннадцать секунд и один цикл двенадцать секунд." },
  { kind:"duration",   name:"Челлендж", minutes:5,  inhale:13, hold:52, exhale:26, announce:"Челлендж. Вдох тринадцать секунд." },
  { kind:"cycles",     name:"Тест",     cycles:3,   inhale:14, hold:56, exhale:28, announce:"Тест. Вдох четырнадцать секунд." },
];
const TOTAL_TARGET_SEC = (10+10+5)*60 + 3*(14+56+28);

// DOM
const blockNameEl=document.getElementById('blockName');
const countEl=document.getElementById('count');
const phaseEl=document.getElementById('phase');
const phaseFill=document.getElementById('phaseFill');
const blockFill=document.getElementById('blockFill');
const totalFill=document.getElementById('totalFill');
const blockRemainEl=document.getElementById('blockRemain');
const totalRemainEl=document.getElementById('totalRemain');
const cyclesDoneEl=document.getElementById('cyclesDone');
const startBtn=document.getElementById('startBtn');
const pauseBtn=document.getElementById('pauseBtn');
const resetBtn=document.getElementById('resetBtn');
const voiceOn=document.getElementById('voiceOn');
const tonesOn=document.getElementById('tonesOn');
const vibeOn=document.getElementById('vibeOn');

// utils
function fmt(sec){sec=Math.max(0,Math.ceil(sec));const m=String(Math.floor(sec/60)).padStart(2,'0');const s=String(sec%60).padStart(2,'0');return `${m}:${s}`;}

// tones
let audioCtx;
function beep(freq=660,ms=180){
  if(!tonesOn.checked) return;
  try{
    audioCtx=audioCtx||new(window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==='suspended') audioCtx.resume();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
    const t=audioCtx.currentTime; g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.2,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+ms/1000); o.start(t); o.stop(t+ms/1000+.02);
  }catch(e){}
}
function phaseTone(n){ if(n==="Вдох")beep(440,200); else if(n==="Задержка")beep(660,160); else beep(520,180); }

// speech
function say(text){
  if(!voiceOn.checked) return;
  const u=new SpeechSynthesisUtterance(text);
  const ru=speechSynthesis.getVoices().find(v=>/ru/i.test(v.lang));
  if(ru) u.voice=ru; u.lang=ru?ru.lang:'ru-RU'; u.rate=0.9; u.pitch=0.95; u.volume=1;
  try{ speechSynthesis.speak(u);}catch(e){}
}

// vibe
function vib(ms=50){ if(vibeOn.checked && navigator.vibrate) navigator.vibrate(ms); }

// wake lock
let wakeLock=null;
async function lockScreen(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); } }catch(e){} }

// state
let running=false, paused=false, timerId=null;
let blockIdx=0, patternIdx=0, phaseIdx=0;
let phaseLeft=0, phaseTotal=0;
let blockLeft=0, blockTotal=0;
let totalElapsed=0, cyclesDone=0;
const PHASES=["Вдох","Задержка","Выдох"];

function setPhase(name,sec){
  phaseEl.textContent=name; phaseLeft=sec; phaseTotal=sec;
  countEl.textContent=fmt(phaseLeft); phaseFill.style.width='0%';
  phaseTone(name); say(name); vib(40);
}
function getDurationsForCurrentCycle(){
  const b=PLAN[blockIdx];
  if(b.kind==="patternDur"){ return b.pattern[patternIdx % b.pattern.length]; }
  return { inhale:b.inhale, hold:b.hold, exhale:b.exhale };
}
function startBlock(i){
  const b=PLAN[i];
  blockNameEl.textContent=b.name;
  blockLeft = (b.kind==="cycles") ? 0 : Math.round((b.minutes||0)*60);
  blockTotal=blockLeft; phaseIdx=0; patternIdx=0;
  say(b.announce || b.name);
  const d=getDurationsForCurrentCycle(); setPhase("Вдох", d.inhale);
  updateHUD();
}
function nextPhaseOrCycle(){
  const b=PLAN[blockIdx];
  phaseIdx=(phaseIdx+1)%3;
  const d=getDurationsForCurrentCycle();
  const seconds=[d.inhale,d.hold,d.exhale][phaseIdx];
  setPhase(PHASES[phaseIdx], seconds);
}
function endOfCycle(){
  cyclesDone+=1; cyclesDoneEl.textContent=String(cyclesDone);
  const b=PLAN[blockIdx];
  if(b.kind==="patternDur"){ patternIdx=(patternIdx+1)%b.pattern.length; }
  if(b.kind==="cycles"){
    b._cyclesLeft=(b._cyclesLeft??b.cycles)-1;
    if(b._cyclesLeft<=0){ goNextBlock(); return; }
  }
  if((b.kind==="duration"||b.kind==="patternDur") && blockLeft<=0){ goNextBlock(); return; }
}
function goNextBlock(){
  blockIdx+=1; if(blockIdx>=PLAN.length){ finishAll(); return; }
  startBlock(blockIdx);
}
function finishAll(){
  running=false; paused=false; clearTimeout(timerId);
  startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=false;
  phaseEl.textContent="Готово"; countEl.textContent="00:00"; blockNameEl.textContent="Сессия завершена";
  phaseFill.style.width=blockFill.style.width=totalFill.style.width='100%';
  say("Пранаяма завершена."); vib(100);
  if(wakeLock){ try{ wakeLock.release(); }catch(e){} }
}
function updateHUD(){
  countEl.textContent=fmt(phaseLeft);
  phaseFill.style.width=`${Math.max(0,Math.min(100,100*(1-phaseLeft/Math.max(1,phaseTotal))))}%`;
  const b=PLAN[blockIdx];
  let blockPct=0, blockTxt="—";
  if(b.kind==="cycles"){
    const left=b._cyclesLeft??b.cycles; blockTxt=left+" циклов"; blockPct=100*(1-left/Math.max(1,b.cycles));
  }else{
    blockTxt=fmt(Math.max(0,blockLeft)); blockPct=100*(1-blockLeft/Math.max(1,blockTotal));
  }
  blockFill.style.width=`${Math.max(0,Math.min(100,blockPct))}%`; blockRemainEl.textContent=blockTxt;
  const totalRemain=Math.max(0,TOTAL_TARGET_SEC-totalElapsed);
  totalRemainEl.textContent=fmt(totalRemain);
  totalFill.style.width=`${Math.max(0,Math.min(100,100*totalElapsed/Math.max(1,TOTAL_TARGET_SEC)))}%`;
}
function tick(){
  if(!running||paused) return;
  phaseLeft-=1; totalElapsed+=1;
  const b=PLAN[blockIdx]; if(b.kind!=="cycles"){ blockLeft=Math.max(0,blockLeft-1); }
  updateHUD();
  if(phaseLeft<=0){
    if(phaseIdx===2){ endOfCycle(); if(!running) return; }
    nextPhaseOrCycle();
  }
  timerId=setTimeout(tick,1000);
}

// controls
function start(){
  if(running) return;
  try{ audioCtx=audioCtx||new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }catch(e){}
  speechSynthesis.cancel();
  running=true; paused=false;
  startBtn.disabled=true; pauseBtn.disabled=false; resetBtn.disabled=false;
  blockIdx=0; patternIdx=0; phaseIdx=0; totalElapsed=0; cyclesDone=0; cyclesDoneEl.textContent="0";
  PLAN.forEach(b=> delete b._cyclesLeft);
  lockScreen();
  startBlock(0);
  clearTimeout(timerId); timerId=setTimeout(tick,1000);
}
function pause(){ if(!running) return; paused=!paused; pauseBtn.textContent=paused?"▶️ Продолжить":"⏸ Пауза"; if(!paused){ clearTimeout(timerId); timerId=setTimeout(tick,1000);} }
function reset(){
  running=false; paused=false; clearTimeout(timerId);
  startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=true;
  blockNameEl.textContent="—"; phaseEl.textContent="Готов";
  phaseFill.style.width=blockFill.style.width=totalFill.style.width="0%";
  countEl.textContent="00:00"; blockRemainEl.textContent="—"; totalRemainEl.textContent="—"; cyclesDoneEl.textContent="0";
  speechSynthesis.cancel(); if(wakeLock){ try{ wakeLock.release(); }catch(e){} }
}
startBtn.addEventListener('click', start);
pauseBtn.addEventListener('click', pause);
resetBtn.addEventListener('click', reset);
if(speechSynthesis.onvoiceschanged!==undefined){ speechSynthesis.onvoiceschanged=()=>{}; }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>–ü—Ä–∞–Ω–∞—è–º–∞ 1‚Äë4‚Äë2 ‚Äî –¢–∞–π–º–µ—Ä —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ + –±–∏–Ω–∞—É—Ä–∞–ª—å–Ω—ã–µ —Ä–∏—Ç–º—ã</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#000; --fg:#f6e7b4; --muted:#b7a97a; --accent:#ffd76a; --accent-dim:#5a481a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{min-height:100%;display:flex;flex-direction:column;gap:14px;padding:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:900px){ .grid{grid-template-columns:1.2fr .8fr} }
  .card{border:1px solid var(--accent-dim);border-radius:14px;padding:14px;background:rgba(255,215,106,.04)}
  .title{font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-size:13px;margin-bottom:6px}
  .block{font-size:20px}
  .count{font-size:80px;line-height:1;font-weight:900;text-shadow:0 0 24px rgba(255,215,106,.25);text-align:center}
  .phase{font-size:16px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);text-align:center}
  .bars{display:flex;flex-direction:column;gap:10px}
  .bar{height:10px;background:linear-gradient(90deg, rgba(255,215,106,.15), rgba(255,215,106,.05));border-radius:999px;border:1px solid rgba(255,215,106,.25);overflow:hidden}
  .fill{height:100%;width:0%;background:linear-gradient(90deg, var(--accent), #f5c542);box-shadow:0 0 12px rgba(255,215,106,.35) inset}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row.center{justify-content:center}
  button{appearance:none;border:1px solid var(--accent-dim);background:transparent;color:var(--fg);
          padding:10px 14px;border-radius:12px;font-weight:800}
  button.primary{background:linear-gradient(180deg,#2a220b,#151006);border-color:#3a2f0f;box-shadow:inset 0 1px 0 rgba(255,255,255,.06)}
  button:disabled{opacity:.45}
  input[type=number], input[type=text]{background:transparent;border:1px solid var(--accent-dim);color:var(--fg);
    border-radius:10px;padding:8px 10px}
  label{color:var(--muted);font-size:14px}
  .pill{display:inline-block;border:1px solid var(--accent-dim);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .kpis .pill b{color:var(--fg)}
  .sec{font-size:12px;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .preset{display:flex;gap:8px;align-items:center}
  .preset input[type=text]{width:160px}
  .hr{height:1px;background:rgba(255,215,106,.18);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <div class="card">
      <div class="title">–ü–ª–µ–µ—Ä</div>
      <div class="block" id="blockName">‚Äî</div>
      <div class="count mono" id="count">00:00</div>
      <div class="phase" id="phase">–ì–æ—Ç–æ–≤</div>
      <div class="bars" style="margin:8px 0 12px;">
        <div class="bar"><div class="fill" id="phaseFill"></div></div>
        <div class="bar"><div class="fill" id="blockFill"></div></div>
        <div class="bar"><div class="fill" id="totalFill"></div></div>
      </div>
      <div class="kpis">
        <span class="pill">–í –±–ª–æ–∫–µ: <b id="blockRemain">‚Äî</b></span>
        <span class="pill">–î–æ –∫–æ–Ω—Ü–∞: <b id="totalRemain">‚Äî</b></span>
        <span class="pill">–¶–∏–∫–ª—ã: <b id="cyclesDone">0</b></span>
      </div>
      <div class="row center" style="margin-top:10px;">
        <button id="startBtn" class="primary">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button id="pauseBtn" disabled>‚è∏ –ü–∞—É–∑–∞</button>
        <button id="resetBtn" disabled>‚ü≤ –°–±—Ä–æ—Å</button>
        <label class="row"><input id="voiceOn" type="checkbox" checked> –ì–æ–ª–æ—Å</label>
        <label class="row"><input id="tonesOn" type="checkbox"> –ë–∏–ø—ã</label>
        <label class="row"><input id="binauralOn" type="checkbox" checked> –ë–∏–Ω–∞—É—Ä–∞–ª—å–Ω—ã–µ</label>
        <label class="row"><input id="vibeOn"  type="checkbox" checked> –í–∏–±—Ä–æ</label>
      </div>
      <div class="sec" style="text-align:center;margin-top:8px;">–î–ª—è –±–∏–Ω–∞—É—Ä–∞–ª—å–Ω—ã—Ö —Ä–∏—Ç–º–æ–≤ –Ω—É–∂–Ω—ã <b>–Ω–∞—É—à–Ω–∏–∫–∏</b>. –î–µ—Ä–∂–∏ –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∏–∑–∫–æ–π. –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è/–∑–≤—É–∫–æ–≤–∞—è —ç–ø–∏–ª–µ–ø—Å–∏—è ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π.</div>
    </div>

    <div class="card">
      <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="list">
        <div><b>1) –†–∞–∑–º–∏–Ω–∫–∞</b></div>
        <div class="row">
          <label>–ú–∏–Ω—É—Ç: <input id="wMin" type="number" min="1" step="1" value="10"></label>
          <label>–í–¥–æ—Ö (1): <input id="wIn" type="number" min="1" step="1" value="10"></label>
          <label>–ó–∞–¥–µ—Ä–∂–∫–∞ (4): <input id="wHold" type="number" min="0" step="1" value="40"></label>
          <label>–í—ã–¥–æ—Ö (2): <input id="wEx" type="number" min="0" step="1" value="20"></label>
          <button id="w142" class="primary">1‚Äë4‚Äë2</button>
        </div>

        <div><b>2) –†–∞–±–æ—Ç–∞ (—á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ)</b></div>
        <div class="row">
          <label>–ú–∏–Ω—É—Ç: <input id="rMin" type="number" min="1" step="1" value="10"></label>
          <label>A –≤–¥–æ—Ö: <input id="rAIn" type="number" min="1" step="1" value="11"></label>
          <label>B –≤–¥–æ—Ö: <input id="rBIn" type="number" min="1" step="1" value="12"></label>
          <label>A —Ü–∏–∫–ª–æ–≤: <input id="rAcount" type="number" min="1" step="1" value="2"></label>
          <label>B —Ü–∏–∫–ª–æ–≤: <input id="rBcount" type="number" min="1" step="1" value="1"></label>
          <button id="r142" class="primary">1‚Äë4‚Äë2 A/B</button>
        </div>

        <div><b>3) –ß–µ–ª–ª–µ–Ω–¥–∂</b></div>
        <div class="row">
          <label>–ú–∏–Ω—É—Ç: <input id="cMin" type="number" min="1" step="1" value="5"></label>
          <label>–í–¥–æ—Ö: <input id="cIn" type="number" min="1" step="1" value="13"></label>
          <label>–ó–∞–¥–µ—Ä–∂–∫–∞: <input id="cHold" type="number" min="0" step="1" value="52"></label>
          <label>–í—ã–¥–æ—Ö: <input id="cEx" type="number" min="0" step="1" value="26"></label>
          <button id="c142" class="primary">1‚Äë4‚Äë2</button>
        </div>

        <div><b>4) –¢–µ—Å—Ç</b></div>
        <div class="row">
          <label>–¶–∏–∫–ª–æ–≤: <input id="tCycles" type="number" min="1" step="1" value="3"></label>
          <label>–í–¥–æ—Ö: <input id="tIn" type="number" min="1" step="1" value="14"></label>
          <label>–ó–∞–¥–µ—Ä–∂–∫–∞: <input id="tHold" type="number" min="0" step="1" value="56"></label>
          <label>–í—ã–¥–æ—Ö: <input id="tEx" type="number" min="0" step="1" value="28"></label>
          <button id="t142" class="primary">1‚Äë4‚Äë2</button>
        </div>

        <div class="hr"></div>
        <div><b>–ë–∏–Ω–∞—É—Ä–∞–ª—å–Ω—ã–µ —Ä–∏—Ç–º—ã (–ì—Ü —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É —É—à–∞–º–∏)</b> ‚Äî –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã</div>
        <div class="row">
          <label>–í–¥–æ—Ö: <input id="bbInhale" type="number" min="0" step="0.5" value="10"></label>
          <label>–ó–∞–¥–µ—Ä–∂–∫–∞: <input id="bbHold" type="number" min="0" step="0.5" value="6"></label>
          <label>–í—ã–¥–æ—Ö: <input id="bbExhale" type="number" min="0" step="0.5" value="3"></label>
          <label>–ù–µ—Å—É—â–∞—è (–ì—Ü): <input id="bbCarrier" type="number" min="100" step="10" value="220"></label>
          <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å (0‚Äì1): <input id="bbGain" type="number" min="0" max="1" step="0.05" value="0.05"></label>
        </div>
        <div class="sec">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: <b>–í–¥–æ—Ö 8‚Äì12 –ì—Ü (–∞–ª—å—Ñ–∞)</b>, <b>–ó–∞–¥–µ—Ä–∂–∫–∞ 4‚Äì7 –ì—Ü (—Ç–µ—Ç–∞)</b>, <b>–í—ã–¥–æ—Ö 2‚Äì4 –ì—Ü (–¥–µ–ª—å—Ç–∞)</b>. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏.</div>

        <div class="hr"></div>
        <div class="row">
          <button id="saveCfg">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="resetCfg">‚ü≤ –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ---- Config storage ----
const KEY_CFG="pranayama_cfg_binaural_v1";
function defaultCfg(){ return {
  warm:{ min:10, in:10, hold:40, ex:20 },
  work:{ min:10, aIn:11, bIn:12, aCount:2, bCount:1 },
  chall:{ min:5, in:13, hold:52, ex:26 },
  test:{ cycles:3, in:14, hold:56, ex:28 },
  bb:{ in:10, hold:6, ex:3, carrier:220, gain:0.05 }
};}
function readCfgFromUI(){
  return {
    warm:{ min:+wMin.value, in:+wIn.value, hold:+wHold.value, ex:+wEx.value },
    work:{ min:+rMin.value, aIn:+rAIn.value, bIn:+rBIn.value, aCount:+rAcount.value, bCount:+rBcount.value },
    chall:{ min:+cMin.value, in:+cIn.value, hold:+cHold.value, ex:+cEx.value },
    test:{ cycles:+tCycles.value, in:+tIn.value, hold:+tHold.value, ex:+tEx.value },
    bb:{ in:+bbInhale.value, hold:+bbHold.value, ex:+bbExhale.value, carrier:+bbCarrier.value, gain:+bbGain.value }
  };
}
function writeCfgToUI(cfg){
  wMin.value=cfg.warm.min; wIn.value=cfg.warm.in; wHold.value=cfg.warm.hold; wEx.value=cfg.warm.ex;
  rMin.value=cfg.work.min; rAIn.value=cfg.work.aIn; rBIn.value=cfg.work.bIn; rAcount.value=cfg.work.aCount; rBcount.value=cfg.work.bCount;
  cMin.value=cfg.chall.min; cIn.value=cfg.chall.in; cHold.value=cfg.chall.hold; cEx.value=cfg.chall.ex;
  tCycles.value=cfg.test.cycles; tIn.value=cfg.test.in; tHold.value=cfg.test.hold; tEx.value=cfg.test.ex;
  bbInhale.value=cfg.bb.in; bbHold.value=cfg.bb.hold; bbExhale.value=cfg.bb.ex; bbCarrier.value=cfg.bb.carrier; bbGain.value=cfg.bb.gain;
}
function saveCfg(cfg){ try{ localStorage.setItem(KEY_CFG, JSON.stringify(cfg)); }catch(e){} }
function loadCfg(){ try{ const t=localStorage.getItem(KEY_CFG); return t?JSON.parse(t):null;}catch(e){ return null; } }

// UI elements
const wMin=document.getElementById('wMin'), wIn=document.getElementById('wIn'), wHold=document.getElementById('wHold'), wEx=document.getElementById('wEx');
const rMin=document.getElementById('rMin'), rAIn=document.getElementById('rAIn'), rBIn=document.getElementById('rBIn'), rAcount=document.getElementById('rAcount'), rBcount=document.getElementById('rBcount');
const cMin=document.getElementById('cMin'), cIn=document.getElementById('cIn'), cHold=document.getElementById('cHold'), cEx=document.getElementById('cEx');
const tCycles=document.getElementById('tCycles'), tIn=document.getElementById('tIn'), tHold=document.getElementById('tHold'), tEx=document.getElementById('tEx');
const bbInhale=document.getElementById('bbInhale'), bbHold=document.getElementById('bbHold'), bbExhale=document.getElementById('bbExhale'), bbCarrier=document.getElementById('bbCarrier'), bbGain=document.getElementById('bbGain');

document.getElementById('w142').onclick=()=>{const x=+wIn.value||0; wHold.value=x*4; wEx.value=x*2;}
document.getElementById('r142').onclick=()=>{alert("–®–∞–±–ª–æ–Ω—ã A/B –±—É–¥—É—Ç 1‚Äë4‚Äë2 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: –∑–∞–¥–µ—Ä–∂–∫–∞=√ó4, –≤—ã–¥–æ—Ö=√ó2 –æ—Ç –≤–¥–æ—Ö–∞.");}
document.getElementById('c142').onclick=()=>{const x=+cIn.value||0; cHold.value=x*4; cEx.value=x*2;}
document.getElementById('t142').onclick=()=>{const x=+tIn.value||0; tHold.value=x*4; tEx.value=x*2;}
document.getElementById('saveCfg').onclick=()=>{ saveCfg(readCfgFromUI()); alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ."); };
document.getElementById('resetCfg').onclick=()=>{ writeCfgToUI(defaultCfg()); saveCfg(readCfgFromUI()); alert("–°–±—Ä–æ—à–µ–Ω–æ."); };

writeCfgToUI(loadCfg()||defaultCfg());

// ----- Player core -----
const blockNameEl=document.getElementById('blockName'), countEl=document.getElementById('count'), phaseEl=document.getElementById('phase');
const phaseFill=document.getElementById('phaseFill'), blockFill=document.getElementById('blockFill'), totalFill=document.getElementById('totalFill');
const blockRemainEl=document.getElementById('blockRemain'), totalRemainEl=document.getElementById('totalRemain'), cyclesDoneEl=document.getElementById('cyclesDone');
const startBtn=document.getElementById('startBtn'), pauseBtn=document.getElementById('pauseBtn'), resetBtn=document.getElementById('resetBtn');
const voiceOn=document.getElementById('voiceOn'), tonesOn=document.getElementById('tonesOn'), binauralOn=document.getElementById('binauralOn'), vibeOn=document.getElementById('vibeOn');

let audioCtx;
let currentBinaural = { leftOsc:null, rightOsc:null, leftGain:null, rightGain:null, masterGain:null };
function ensureAudio(){ audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); return audioCtx; }

// simple beeps (if enabled)
function beep(freq=660,ms=180){
  if(!tonesOn.checked) return;
  try{
    const ctx=ensureAudio();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
    const t=ctx.currentTime; g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.2,t+.01); g.gain.exponentialRampToValueAtTime(0.0001,t+ms/1000);
    o.start(t); o.stop(t+ms/1000+.02);
  }catch(e){}
}
function phaseTone(n){ if(!tonesOn.checked) return; if(n==="–í–¥–æ—Ö")beep(440,200); else if(n==="–ó–∞–¥–µ—Ä–∂–∫–∞")beep(660,160); else beep(520,180); }

// binaural beats (if enabled) ‚Äî continuous during phase
function stopBinaural(){
  const ctx=audioCtx;
  if(!ctx) return;
  const {leftOsc,rightOsc,leftGain,rightGain,masterGain}=currentBinaural;
  try{
    const t=ctx.currentTime;
    [leftGain,rightGain,masterGain].forEach(g=>{ if(g){ g.gain.cancelScheduledValues(t); g.gain.setTargetAtTime(0.0001,t,0.15); } });
    [leftOsc,rightOsc].forEach(o=>{ if(o){ try{o.stop(t+0.2);}catch(e){} } });
  }catch(e){}
  currentBinaural={ leftOsc:null,rightOsc:null,leftGain:null,rightGain:null,masterGain:null };
}
function startBinaural(beatHz, carrier=220, gainValue=0.05){
  if(!binauralOn.checked) return;
  try{
    const ctx=ensureAudio();
    stopBinaural();
    const master=ctx.createGain(); master.gain.value=0.0001;
    const merger=ctx.createChannelMerger(2);
    const leftOsc=ctx.createOscillator(); const rightOsc=ctx.createOscillator();
    const leftGain=ctx.createGain(); const rightGain=ctx.createGain();
    leftGain.gain.value=1; rightGain.gain.value=1;
    leftOsc.type='sine'; rightOsc.type='sine';
    // left/right frequencies with small difference = beatHz
    leftOsc.frequency.value = carrier - beatHz/2;
    rightOsc.frequency.value = carrier + beatHz/2;
    leftOsc.connect(leftGain); rightOsc.connect(rightGain);
    leftGain.connect(merger,0,0); rightGain.connect(merger,0,1);
    merger.connect(master); master.connect(ctx.destination);
    const t=ctx.currentTime;
    master.gain.setValueAtTime(0.0001,t);
    master.gain.exponentialRampToValueAtTime(gainValue, t+0.3); // fade in
    leftOsc.start(t); rightOsc.start(t);
    currentBinaural={ leftOsc,rightOsc,leftGain,rightGain,masterGain:master };
  }catch(e){ /* safari older? falls back silently */ }
}

// speech + vibro
function say(text){ if(!voiceOn.checked) return; const u=new SpeechSynthesisUtterance(text); const ru=speechSynthesis.getVoices().find(v=>/ru/i.test(v.lang)); if(ru) u.voice=ru; u.lang=ru?ru.lang:'ru-RU'; u.rate=.9; u.pitch=.95; try{ speechSynthesis.speak(u);}catch(e){} }
function vib(ms=50){ if(vibeOn.checked && navigator.vibrate) navigator.vibrate(ms); }

// wake lock
let wakeLock=null; async function lockScreen(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); } }catch(e){} }

// state
let running=false, paused=false, timerId=null;
let blockIdx=0, patternSeq=[], patternPos=0, phaseIdx=0;
let phaseLeft=0, phaseTotal=0, blockLeft=0, blockTotal=0, totalElapsed=0, cyclesDone=0, totalTarget=0;
const PHASES=["–í–¥–æ—Ö","–ó–∞–¥–µ—Ä–∂–∫–∞","–í—ã–¥–æ—Ö"];

function buildPlan(cfg){
  const patt=[];
  for(let i=0;i<cfg.work.aCount;i++){ patt.push({in:cfg.work.aIn, hold:cfg.work.aIn*4, ex:cfg.work.aIn*2}); }
  for(let i=0;i<cfg.work.bCount;i++){ patt.push({in:cfg.work.bIn, hold:cfg.work.bIn*4, ex:cfg.work.bIn*2}); }
  return [
    { kind:"duration", name:"–†–∞–∑–º–∏–Ω–∫–∞", minutes:cfg.warm.min, inhale:cfg.warm.in, hold:cfg.warm.hold, exhale:cfg.warm.ex, announce:`–†–∞–∑–º–∏–Ω–∫–∞. –í–¥–æ—Ö ${cfg.warm.in} —Å–µ–∫—É–Ω–¥.` },
    { kind:"patternDur", name:"–†–∞–±–æ—Ç–∞", minutes:cfg.work.min, pattern:patt, announce:`–†–∞–±–æ—Ç–∞. –ß–µ—Ä–µ–¥—É–µ–º ${cfg.work.aCount}√ó${cfg.work.aIn} –∏ ${cfg.work.bCount}√ó${cfg.work.bIn} —Å–µ–∫—É–Ω–¥.` },
    { kind:"duration", name:"–ß–µ–ª–ª–µ–Ω–¥–∂", minutes:cfg.chall.min, inhale:cfg.chall.in, hold:cfg.chall.hold, exhale:cfg.chall.ex, announce:`–ß–µ–ª–ª–µ–Ω–¥–∂. –í–¥–æ—Ö ${cfg.chall.in} —Å–µ–∫—É–Ω–¥.` },
    { kind:"cycles", name:"–¢–µ—Å—Ç", cycles:cfg.test.cycles, inhale:cfg.test.in, hold:cfg.test.hold, exhale:cfg.test.ex, announce:`–¢–µ—Å—Ç. –í–¥–æ—Ö ${cfg.test.in} —Å–µ–∫—É–Ω–¥.` },
  ];
}

function fmt(s){ s=Math.max(0,Math.ceil(s)); const m=String(Math.floor(s/60)).padStart(2,'0'); const x=String(s%60).padStart(2,'0'); return `${m}:${x}`; }
function setPhase(name,sec,bbCfg){
  phaseEl.textContent=name; phaseLeft=sec; phaseTotal=sec;
  countEl.textContent=fmt(sec); phaseFill.style.width='0%';
  if(tonesOn.checked) phaseTone(name);
  if(binauralOn.checked){ const beat = name==="–í–¥–æ—Ö"?bbCfg.in : (name==="–ó–∞–¥–µ—Ä–∂–∫–∞"?bbCfg.hold : bbCfg.ex); startBinaural(beat, bbCfg.carrier, bbCfg.gain); }
  say(name); vib(40);
}
function getDur(cfg){ const b=PLAN[blockIdx]; if(b.kind==="patternDur"){ const p=b.pattern[patternPos % b.pattern.length]; return {inh:p.in, hold:p.hold, ex:p.ex}; } return {inh:b.inhale, hold:b.hold, ex:b.exhale}; }
function startBlock(i,cfg){
  const b=PLAN[i]; blockNameEl.textContent=b.name;
  blockLeft=(b.kind==="cycles")?0:Math.round((b.minutes||0)*60); blockTotal=blockLeft; patternPos=0; phaseIdx=0;
  say(b.announce||b.name);
  const d=getDur(cfg); setPhase("–í–¥–æ—Ö", d.inh, cfg.bb); updateHUD(cfg);
}
function nextPhaseOrCycle(cfg){
  const d=getDur(cfg); phaseIdx=(phaseIdx+1)%3; const sec=[d.inh,d.hold,d.ex][phaseIdx]; setPhase(PHASES[phaseIdx],sec,cfg.bb);
}
function endCycle(cfg){
  cyclesDone+=1; cyclesDoneEl.textContent=String(cyclesDone);
  const b=PLAN[blockIdx];
  if(b.kind==="patternDur"){ patternPos=(patternPos+1)%b.pattern.length; }
  if(b.kind==="cycles"){ b._left=(b._left??b.cycles)-1; if(b._left<=0){ nextBlock(cfg); return; } }
  if((b.kind==="duration"||b.kind==="patternDur") && blockLeft<=0){ nextBlock(cfg); return; }
}
function nextBlock(cfg){ stopBinaural(); blockIdx+=1; if(blockIdx>=PLAN.length){ finish(); return; } startBlock(blockIdx,cfg); }
function finish(){ running=false; paused=false; clearTimeout(timerId); startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=false; phaseEl.textContent="–ì–æ—Ç–æ–≤–æ"; countEl.textContent="00:00"; blockNameEl.textContent="–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"; phaseFill.style.width=blockFill.style.width=totalFill.style.width="100%"; say("–ü—Ä–∞–Ω–∞—è–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."); vib(100); stopBinaural(); if(wakeLock){ try{ wakeLock.release(); }catch(e){} } }
function updateHUD(cfg){
  countEl.textContent=fmt(phaseLeft); phaseFill.style.width=`${Math.max(0,Math.min(100,100*(1-phaseLeft/Math.max(1,phaseTotal))))}%`;
  const b=PLAN[blockIdx]; let blockPct=0, txt="‚Äî";
  if(b.kind==="cycles"){ const left=b._left??b.cycles; txt=left+" —Ü–∏–∫–ª–æ–≤"; blockPct=100*(1-left/Math.max(1,b.cycles)); }
  else { txt=fmt(Math.max(0,blockLeft)); blockPct=100*(1-blockLeft/Math.max(1,blockTotal)); }
  blockFill.style.width=`${Math.max(0,Math.min(100,blockPct))}%`; blockRemainEl.textContent=txt;
  const remain=Math.max(0,totalTarget-totalElapsed); totalRemainEl.textContent=fmt(remain);
  totalFill.style.width=`${Math.max(0,Math.min(100,100*totalElapsed/Math.max(1,totalTarget)))}%`;
}

let running=false, paused=false, timerId=null, totalElapsed=0, totalTarget=0;
let blockIdx=0, patternPos=0, phaseIdx=0, phaseLeft=0, phaseTotal=0, blockLeft=0, blockTotal=0, cyclesDone=0;

function start(){
  if(running) return;
  const cfg=readCfgFromUI(); saveCfg(cfg);
  PLAN = buildPlan(cfg);
  totalTarget = (PLAN[0].minutes + PLAN[1].minutes + PLAN[2].minutes)*60 + PLAN[3].cycles*(PLAN[3].inhale+PLAN[3].hold+PLAN[3].exhale);
  try{ ensureAudio(); }catch(e){}
  speechSynthesis.cancel();
  running=true; paused=false; startBtn.disabled=true; pauseBtn.disabled=false; resetBtn.disabled=false;
  blockIdx=0; patternPos=0; phaseIdx=0; totalElapsed=0; cyclesDone=0; cyclesDoneEl.textContent="0";
  PLAN.forEach(b=> delete b._left);
  lockScreen();
  startBlock(0,cfg);
  clearTimeout(timerId); timerId=setTimeout(function tickWrap(){
    if(!running||paused) return;
    phaseLeft-=1; totalElapsed+=1;
    const b=PLAN[blockIdx]; if(b.kind!=="cycles"){ blockLeft=Math.max(0,blockLeft-1); }
    updateHUD(cfg);
    if(phaseLeft<=0){ if(phaseIdx===2){ endCycle(cfg); if(!running) return; } nextPhaseOrCycle(cfg); }
    timerId=setTimeout(tickWrap,1000);
  }, 1000);
}
function pause(){ if(!running) return; paused=!paused; pauseBtn.textContent=paused?"‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å":"‚è∏ –ü–∞—É–∑–∞"; if(!paused){ clearTimeout(timerId); timerId=setTimeout(()=>{ /* resume loop */ }, 1000);} }
function reset(){ running=false; paused=false; clearTimeout(timerId); startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=true; blockNameEl.textContent="‚Äî"; phaseEl.textContent="–ì–æ—Ç–æ–≤"; phaseFill.style.width=blockFill.style.width=totalFill.style.width="0%"; countEl.textContent="00:00"; blockRemainEl.textContent="‚Äî"; totalRemainEl.textContent="‚Äî"; cyclesDoneEl.textContent="0"; speechSynthesis.cancel(); stopBinaural(); if(wakeLock){ try{ wakeLock.release(); }catch(e){} } }

startBtn.addEventListener('click', start);
pauseBtn.addEventListener('click', pause);
resetBtn.addEventListener('click', reset);
if(speechSynthesis.onvoiceschanged!==undefined){ speechSynthesis.onvoiceschanged=()=>{}; }
</script>
</body>
</html>

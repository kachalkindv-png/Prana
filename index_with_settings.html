<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>–ü—Ä–∞–Ω–∞—è–º–∞ 1‚Äë4‚Äë2 ‚Äî –¢–∞–π–º–µ—Ä —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#000; --fg:#f6e7b4; --muted:#b7a97a; --accent:#ffd76a; --accent-dim:#5a481a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{min-height:100%;display:flex;flex-direction:column;gap:14px;padding:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:900px){ .grid{grid-template-columns:1.2fr .8fr} }
  .card{border:1px solid var(--accent-dim);border-radius:14px;padding:14px;background:rgba(255,215,106,.04)}
  .title{font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-size:13px;margin-bottom:6px}
  .block{font-size:20px}
  .count{font-size:80px;line-height:1;font-weight:900;text-shadow:0 0 24px rgba(255,215,106,.25);text-align:center}
  .phase{font-size:16px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);text-align:center}
  .bars{display:flex;flex-direction:column;gap:10px}
  .bar{height:10px;background:linear-gradient(90deg, rgba(255,215,106,.15), rgba(255,215,106,.05));border-radius:999px;border:1px solid rgba(255,215,106,.25);overflow:hidden}
  .fill{height:100%;width:0%;background:linear-gradient(90deg, var(--accent), #f5c542);box-shadow:0 0 12px rgba(255,215,106,.35) inset}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row.center{justify-content:center}
  button{appearance:none;border:1px solid var(--accent-dim);background:transparent;color:var(--fg);
          padding:10px 14px;border-radius:12px;font-weight:800}
  button.primary{background:linear-gradient(180deg,#2a220b,#151006);border-color:#3a2f0f;box-shadow:inset 0 1px 0 rgba(255,255,255,.06)}
  button:disabled{opacity:.45}
  input[type=number], input[type=text]{background:transparent;border:1px solid var(--accent-dim);color:var(--fg);
    border-radius:10px;padding:8px 10px}
  label{color:var(--muted);font-size:14px}
  .pill{display:inline-block;border:1px solid var(--accent-dim);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .kpis .pill b{color:var(--fg)}
  .sec{font-size:12px;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .preset{display:flex;gap:8px;align-items:center}
  .preset input[type=text]{width:160px}
</style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <div class="card">
      <div class="title">–ü–ª–µ–µ—Ä</div>
      <div class="block" id="blockName">‚Äî</div>
      <div class="count mono" id="count">00:00</div>
      <div class="phase" id="phase">–ì–æ—Ç–æ–≤</div>
      <div class="bars" style="margin:8px 0 12px;">
        <div class="bar"><div class="fill" id="phaseFill"></div></div>
        <div class="bar"><div class="fill" id="blockFill"></div></div>
        <div class="bar"><div class="fill" id="totalFill"></div></div>
      </div>
      <div class="kpis">
        <span class="pill">–í –±–ª–æ–∫–µ: <b id="blockRemain">‚Äî</b></span>
        <span class="pill">–î–æ –∫–æ–Ω—Ü–∞: <b id="totalRemain">‚Äî</b></span>
        <span class="pill">–¶–∏–∫–ª—ã: <b id="cyclesDone">0</b></span>
      </div>
      <div class="row center" style="margin-top:10px;">
        <button id="startBtn" class="primary">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button id="pauseBtn" disabled>‚è∏ –ü–∞—É–∑–∞</button>
        <button id="resetBtn" disabled>‚ü≤ –°–±—Ä–æ—Å</button>
        <label class="row"><input id="voiceOn" type="checkbox" checked> –ì–æ–ª–æ—Å</label>
        <label class="row"><input id="tonesOn" type="checkbox" checked> –¢–æ–Ω—ã</label>
        <label class="row"><input id="vibeOn"  type="checkbox" checked> –í–∏–±—Ä–æ</label>
      </div>
      <div class="sec" style="text-align:center;margin-top:8px;">–ù–∞ iPhone –ø–æ—Å–ª–µ ¬´–°—Ç–∞—Ä—Ç¬ª –∑–≤—É–∫ –∏ –≥–æ–ª–æ—Å –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è. –≠–∫—Ä–∞–Ω –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ—Ç –∑–∞—Å—ã–ø–∞–Ω–∏—è.</div>
    </div>

    <div class="card">
      <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–∏</div>
      <div class="list">
        <div><b>1) –†–∞–∑–º–∏–Ω–∫–∞</b></div>
        <div class="row">
          <label>–ú–∏–Ω—É—Ç: <input id="wMin" type="number" min="1" step="1" value="10"></label>
          <label>–í–¥–æ—Ö (1): <input id="wIn" type="number" min="1" step="1" value="10"></label>
          <label>–ó–∞–¥–µ—Ä–∂–∫–∞ (4): <input id="wHold" type="number" min="0" step="1" value="40"></label>
          <label>–í—ã–¥–æ—Ö (2): <input id="wEx" type="number" min="0" step="1" value="20"></label>
          <button id="w142" class="primary">1‚Äë4‚Äë2</button>
        </div>

        <div><b>2) –†–∞–±–æ—Ç–∞ (—á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ)</b></div>
        <div class="row">
          <label>–ú–∏–Ω—É—Ç: <input id="rMin" type="number" min="1" step="1" value="10"></label>
          <label>–®–∞–±–ª–æ–Ω A (–≤–¥–æ—Ö): <input id="rAIn" type="number" min="1" step="1" value="11"></label>
          <label>–®–∞–±–ª–æ–Ω B (–≤–¥–æ—Ö): <input id="rBIn" type="number" min="1" step="1" value="12"></label>
          <label>A —Ü–∏–∫–ª–æ–≤: <input id="rAcount" type="number" min="1" step="1" value="2"></label>
          <label>B —Ü–∏–∫–ª–æ–≤: <input id="rBcount" type="number" min="1" step="1" value="1"></label>
          <button id="r142" class="primary">1‚Äë4‚Äë2 –¥–ª—è A/B</button>
        </div>

        <div><b>3) –ß–µ–ª–ª–µ–Ω–¥–∂</b></div>
        <div class="row">
          <label>–ú–∏–Ω—É—Ç: <input id="cMin" type="number" min="1" step="1" value="5"></label>
          <label>–í–¥–æ—Ö: <input id="cIn" type="number" min="1" step="1" value="13"></label>
          <label>–ó–∞–¥–µ—Ä–∂–∫–∞: <input id="cHold" type="number" min="0" step="1" value="52"></label>
          <label>–í—ã–¥–æ—Ö: <input id="cEx" type="number" min="0" step="1" value="26"></label>
          <button id="c142" class="primary">1‚Äë4‚Äë2</button>
        </div>

        <div><b>4) –¢–µ—Å—Ç</b></div>
        <div class="row">
          <label>–¶–∏–∫–ª–æ–≤: <input id="tCycles" type="number" min="1" step="1" value="3"></label>
          <label>–í–¥–æ—Ö: <input id="tIn" type="number" min="1" step="1" value="14"></label>
          <label>–ó–∞–¥–µ—Ä–∂–∫–∞: <input id="tHold" type="number" min="0" step="1" value="56"></label>
          <label>–í—ã–¥–æ—Ö: <input id="tEx" type="number" min="0" step="1" value="28"></label>
          <button id="t142" class="primary">1‚Äë4‚Äë2</button>
        </div>

        <div class="row">
          <button id="saveCfg">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button id="loadCfg">‚≠≥ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button id="resetCfg">‚ü≤ –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div class="title" style="margin-top:10px">–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏</div>
        <div id="presets" class="list"></div>
        <div class="row">
          <input id="presetName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞">
          <button id="savePreset" class="primary">Ôºã –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –ø—Ä–µ—Å–µ—Ç</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const KEY_CFG = "pranayama_cfg_v3";
const KEY_PRESETS = "pranayama_presets_v3";

// Shortcuts to inputs
const wMin=wMinEl(), wIn=wInEl(), wHold=wHoldEl(), wEx=wExEl();
const rMin=rMinEl(), rAIn=rAInEl(), rBIn=rBInEl(), rAcount=rAcountEl(), rBcount=rBcountEl();
const cMin=cMinEl(), cIn=cInEl(), cHold=cHoldEl(), cEx=cExEl();
const tCycles=tCyclesEl(), tIn=tInEl(), tHold=tHoldEl(), tEx=tExEl();

function wMinEl(){return document.getElementById('wMin')}
function wInEl(){return document.getElementById('wIn')}
function wHoldEl(){return document.getElementById('wHold')}
function wExEl(){return document.getElementById('wEx')}

function rMinEl(){return document.getElementById('rMin')}
function rAInEl(){return document.getElementById('rAIn')}
function rBInEl(){return document.getElementById('rBIn')}
function rAcountEl(){return document.getElementById('rAcount')}
function rBcountEl(){return document.getElementById('rBcount')}

function cMinEl(){return document.getElementById('cMin')}
function cInEl(){return document.getElementById('cIn')}
function cHoldEl(){return document.getElementById('cHold')}
function cExEl(){return document.getElementById('cEx')}

function tCyclesEl(){return document.getElementById('tCycles')}
function tInEl(){return document.getElementById('tIn')}
function tHoldEl(){return document.getElementById('tHold')}
function tExEl(){return document.getElementById('tEx')}

document.getElementById('w142').onclick=()=>{const x=+wIn.value||0; wHold.value=x*4; wEx.value=x*2;}
document.getElementById('r142').onclick=()=>{
  const a=+rAIn.value||0, b=+rBIn.value||0;
  alert("–î–ª—è A/B 1‚Äë4‚Äë2: –∑–∞–¥–µ—Ä–∂–∫–∞=√ó4, –≤—ã–¥–æ—Ö=√ó2. –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –ø–ª–µ–µ—Ä–µ.");
}
document.getElementById('c142').onclick=()=>{const x=+cIn.value||0; cHold.value=x*4; cEx.value=x*2;}
document.getElementById('t142').onclick=()=>{const x=+tIn.value||0; tHold.value=x*4; tEx.value=x*2;}

document.getElementById('saveCfg').onclick=()=>{ saveCfg(readCfg()); alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."); }
document.getElementById('loadCfg').onclick=()=>{ const cfg=loadCfg(); if(cfg){ writeCfg(cfg); alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã."); } else alert("–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç."); };
document.getElementById('resetCfg').onclick=()=>{ writeCfg(defaultCfg()); alert("–°–±—Ä–æ—à–µ–Ω–æ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É."); };

document.getElementById('savePreset').onclick=()=>{
  const name=(document.getElementById('presetName').value||"").trim();
  if(!name) { alert("–î–∞–π –∏–º—è –ø—Ä–µ—Å–µ—Ç—É."); return; }
  const presets=loadPresets(); presets.push({ name, cfg: readCfg() });
  savePresets(presets); renderPresets(); document.getElementById('presetName').value="";
  alert("–ü—Ä–µ—Å–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω.");
};

function readCfg(){
  return {
    warm:{ min:+wMin.value, in:+wIn.value, hold:+wHold.value, ex:+wEx.value },
    work:{ min:+rMin.value, aIn:+rAIn.value, bIn:+rBIn.value, aCount:+rAcount.value, bCount:+rBcount.value },
    chall:{ min:+cMin.value, in:+cIn.value, hold:+cHold.value, ex:+cEx.value },
    test:{ cycles:+tCycles.value, in:+tIn.value, hold:+tHold.value, ex:+tEx.value },
  };
}
function writeCfg(cfg){
  wMin.value=cfg.warm.min; wIn.value=cfg.warm.in; wHold.value=cfg.warm.hold; wEx.value=cfg.warm.ex;
  rMin.value=cfg.work.min; rAIn.value=cfg.work.aIn; rBIn.value=cfg.work.bIn; rAcount.value=cfg.work.aCount; rBcount.value=cfg.work.bCount;
  cMin.value=cfg.chall.min; cIn.value=cfg.chall.in; cHold.value=cfg.chall.hold; cEx.value=cfg.chall.ex;
  tCycles.value=cfg.test.cycles; tIn.value=cfg.test.in; tHold.value=cfg.test.hold; tEx.value=cfg.test.ex;
}
function defaultCfg(){
  return {
    warm:{ min:10, in:10, hold:40, ex:20 },
    work:{ min:10, aIn:11, bIn:12, aCount:2, bCount:1 },
    chall:{ min:5,  in:13, hold:52, ex:26 },
    test:{ cycles:3, in:14, hold:56, ex:28 },
  };
}
function saveCfg(cfg){ try{ localStorage.setItem(KEY_CFG, JSON.stringify(cfg)); }catch(e){} }
function loadCfg(){ try{ const t=localStorage.getItem(KEY_CFG); return t?JSON.parse(t):null; }catch(e){ return null; } }
function loadPresets(){ try{ const t=localStorage.getItem(KEY_PRESETS); return t?JSON.parse(t):[]; }catch(e){ return []; } }
function savePresets(p){ try{ localStorage.setItem(KEY_PRESETS, JSON.stringify(p)); }catch(e){} }

function renderPresets(){
  const holder=document.getElementById('presets'); holder.innerHTML="";
  const presets=loadPresets();
  if(!presets.length){ holder.innerHTML='<div class="sec">–ü–æ–∫–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤ –Ω–µ—Ç.</div>'; return; }
  presets.forEach((p,i)=>{
    const row=document.createElement('div'); row.className='preset';
    const name=document.createElement('input'); name.type='text'; name.value=p.name;
    const loadBtn=document.createElement('button'); loadBtn.textContent='–ó–∞–≥—Ä—É–∑–∏—Ç—å'; loadBtn.onclick=()=>{ writeCfg(p.cfg); alert('–ü—Ä–µ—Å–µ—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω.'); };
    const del=document.createElement('button'); del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.onclick=()=>{ const all=loadPresets(); all.splice(i,1); savePresets(all); renderPresets(); };
    row.appendChild(name); row.appendChild(loadBtn); row.appendChild(del); holder.appendChild(row);
  });
}
writeCfg(loadCfg()||defaultCfg()); renderPresets();

// ---------------- –ü–ª–µ–µ—Ä (–æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ –∫–∞–∫ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏) ----------------
const blockNameEl=document.getElementById('blockName');
const countEl=document.getElementById('count');
const phaseEl=document.getElementById('phase');
const phaseFill=document.getElementById('phaseFill');
const blockFill=document.getElementById('blockFill');
const totalFill=document.getElementById('totalFill');
const blockRemainEl=document.getElementById('blockRemain');
const totalRemainEl=document.getElementById('totalRemain');
const cyclesDoneEl=document.getElementById('cyclesDone');
const startBtn=document.getElementById('startBtn');
const pauseBtn=document.getElementById('pauseBtn');
const resetBtn=document.getElementById('resetBtn');
const voiceOn=document.getElementById('voiceOn');
const tonesOn=document.getElementById('tonesOn');
const vibeOn=document.getElementById('vibeOn');

let audioCtx; function beep(f=660,ms=180){ if(!tonesOn.checked) return;
  try{ audioCtx=audioCtx||new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
    const t=audioCtx.currentTime; g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.2,t+.01); g.gain.exponentialRampToValueAtTime(0.0001,t+ms/1000);
    o.start(t); o.stop(t+ms/1000+.02);}catch(e){} }
function phaseTone(n){ if(n==="–í–¥–æ—Ö")beep(440,200); else if(n==="–ó–∞–¥–µ—Ä–∂–∫–∞")beep(660,160); else beep(520,180); }
function say(text){ if(!voiceOn.checked) return; const u=new SpeechSynthesisUtterance(text); const ru=speechSynthesis.getVoices().find(v=>/ru/i.test(v.lang)); if(ru) u.voice=ru; u.lang=ru?ru.lang:'ru-RU'; u.rate=.9; u.pitch=.95; try{ speechSynthesis.speak(u);}catch(e){} }
function vib(ms=50){ if(vibeOn.checked && navigator.vibrate) navigator.vibrate(ms); }
let wakeLock=null; async function lockScreen(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); } }catch(e){} }

let running=false, paused=false, timerId=null;
let blockIdx=0, patternSeq=[], patternPos=0, phaseIdx=0;
let phaseLeft=0, phaseTotal=0, blockLeft=0, blockTotal=0, totalElapsed=0, cyclesDone=0, totalTarget=0;

const PHASES=["–í–¥–æ—Ö","–ó–∞–¥–µ—Ä–∂–∫–∞","–í—ã–¥–æ—Ö"];

function buildPlan(cfg){
  // pattern sequence for work: A repeated aCount, then B repeated bCount
  const patt=[];
  for(let i=0;i<cfg.work.aCount;i++){ patt.push({in:cfg.work.aIn, hold:cfg.work.aIn*4, ex:cfg.work.aIn*2}); }
  for(let i=0;i<cfg.work.bCount;i++){ patt.push({in:cfg.work.bIn, hold:cfg.work.bIn*4, ex:cfg.work.bIn*2}); }
  return [
    { kind:"duration", name:"–†–∞–∑–º–∏–Ω–∫–∞", minutes:cfg.warm.min, inhale:cfg.warm.in, hold:cfg.warm.hold, exhale:cfg.warm.ex,
      announce:`–†–∞–∑–º–∏–Ω–∫–∞. –í–¥–æ—Ö ${cfg.warm.in} —Å–µ–∫—É–Ω–¥.` },
    { kind:"patternDur", name:"–†–∞–±–æ—Ç–∞", minutes:cfg.work.min, pattern:patt,
      announce:`–†–∞–±–æ—Ç–∞. –ß–µ—Ä–µ–¥—É–µ–º ${cfg.work.aCount}√ó${cfg.work.aIn} –∏ ${cfg.work.bCount}√ó${cfg.work.bIn} —Å–µ–∫—É–Ω–¥.` },
    { kind:"duration", name:"–ß–µ–ª–ª–µ–Ω–¥–∂", minutes:cfg.chall.min, inhale:cfg.chall.in, hold:cfg.chall.hold, exhale:cfg.chall.ex,
      announce:`–ß–µ–ª–ª–µ–Ω–¥–∂. –í–¥–æ—Ö ${cfg.chall.in} —Å–µ–∫—É–Ω–¥.` },
    { kind:"cycles", name:"–¢–µ—Å—Ç", cycles:cfg.test.cycles, inhale:cfg.test.in, hold:cfg.test.hold, exhale:cfg.test.ex,
      announce:`–¢–µ—Å—Ç. –í–¥–æ—Ö ${cfg.test.in} —Å–µ–∫—É–Ω–¥.` },
  ];
}
let PLAN = buildPlan(readCfg());

function fmt(s){ s=Math.max(0,Math.ceil(s)); const m=String(Math.floor(s/60)).padStart(2,'0'); const x=String(s%60).padStart(2,'0'); return `${m}:${x}`; }

function setPhase(name,sec){ phaseEl.textContent=name; phaseLeft=sec; phaseTotal=sec; countEl.textContent=fmt(sec); phaseFill.style.width='0%'; phaseTone(name); say(name); vib(40); }
function getDur(){ const b=PLAN[blockIdx]; if(b.kind==="patternDur"){ const p=b.pattern[patternPos % b.pattern.length]; return {inh:p.in, hold:p.hold, ex:p.ex}; } return {inh:b.inhale, hold:b.hold, ex:b.exhale}; }
function startBlock(i){
  const b=PLAN[i]; blockNameEl.textContent=b.name;
  blockLeft = (b.kind==="cycles") ? 0 : Math.round((b.minutes||0)*60); blockTotal=blockLeft;
  patternPos=0; phaseIdx=0; say(b.announce||b.name);
  const d=getDur(); setPhase("–í–¥–æ—Ö", d.inh); updateHUD();
}
function nextPhaseOrCycle(){
  const d=getDur(); phaseIdx=(phaseIdx+1)%3; const sec=[d.inh,d.hold,d.ex][phaseIdx]; setPhase(PHASES[phaseIdx],sec);
}
function endCycle(){
  cyclesDone+=1; cyclesDoneEl.textContent=String(cyclesDone);
  const b=PLAN[blockIdx];
  if(b.kind==="patternDur"){ patternPos=(patternPos+1)%b.pattern.length; }
  if(b.kind==="cycles"){ b._left=(b._left??b.cycles)-1; if(b._left<=0){ nextBlock(); return; } }
  if((b.kind==="duration"||b.kind==="patternDur") && blockLeft<=0){ nextBlock(); return; }
}
function nextBlock(){ blockIdx+=1; if(blockIdx>=PLAN.length){ finish(); return; } startBlock(blockIdx); }
function finish(){ running=false; paused=false; clearTimeout(timerId); startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=false; phaseEl.textContent="–ì–æ—Ç–æ–≤–æ"; countEl.textContent="00:00"; blockNameEl.textContent="–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"; phaseFill.style.width=blockFill.style.width=totalFill.style.width="100%"; say("–ü—Ä–∞–Ω–∞—è–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."); vib(100); if(wakeLock){ try{ wakeLock.release(); }catch(e){} } }
function updateHUD(){
  countEl.textContent=fmt(phaseLeft); phaseFill.style.width=`${Math.max(0,Math.min(100,100*(1-phaseLeft/Math.max(1,phaseTotal))))}%`;
  const b=PLAN[blockIdx]; let blockPct=0, txt="‚Äî";
  if(b.kind==="cycles"){ const left=b._left??b.cycles; txt=left+" —Ü–∏–∫–ª–æ–≤"; blockPct=100*(1-left/Math.max(1,b.cycles)); }
  else { txt=fmt(Math.max(0,blockLeft)); blockPct=100*(1-blockLeft/Math.max(1,blockTotal)); }
  blockFill.style.width=`${Math.max(0,Math.min(100,blockPct))}%`; blockRemainEl.textContent=txt;
  const remain=Math.max(0,totalTarget-totalElapsed); totalRemainEl.textContent=fmt(remain);
  totalFill.style.width=`${Math.max(0,Math.min(100,100*totalElapsed/Math.max(1,totalTarget)))}%`;
}

let totalElapsed=0;
function tick(){
  if(!running||paused) return;
  phaseLeft-=1; totalElapsed+=1;
  const b=PLAN[blockIdx]; if(b.kind!=="cycles"){ blockLeft=Math.max(0,blockLeft-1); }
  updateHUD();
  if(phaseLeft<=0){ if(phaseIdx===2){ endCycle(); if(!running) return; } nextPhaseOrCycle(); }
  timerId=setTimeout(tick,1000);
}

function start(){
  if(running) return;
  try{ audioCtx=audioCtx||new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }catch(e){}
  speechSynthesis.cancel();
  PLAN = buildPlan(readCfg());
  totalTarget = (PLAN[0].minutes + PLAN[1].minutes + PLAN[2].minutes)*60 + PLAN[3].cycles * (PLAN[3].inhale + PLAN[3].hold + PLAN[3].exhale);
  running=true; paused=false; startBtn.disabled=true; pauseBtn.disabled=false; resetBtn.disabled=false;
  blockIdx=0; phaseIdx=0; patternPos=0; totalElapsed=0; cyclesDone=0; cyclesDoneEl.textContent="0";
  PLAN.forEach(b=> delete b._left);
  lockScreen();
  startBlock(0);
  clearTimeout(timerId); timerId=setTimeout(tick,1000);
}
function pause(){ if(!running) return; paused=!paused; pauseBtn.textContent=paused?"‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å":"‚è∏ –ü–∞—É–∑–∞"; if(!paused){ clearTimeout(timerId); timerId=setTimeout(tick,1000);} }
function reset(){ running=false; paused=false; clearTimeout(timerId); startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=true; blockNameEl.textContent="‚Äî"; phaseEl.textContent="–ì–æ—Ç–æ–≤"; phaseFill.style.width=blockFill.style.width=totalFill.style.width="0%"; countEl.textContent="00:00"; blockRemainEl.textContent="‚Äî"; totalRemainEl.textContent="‚Äî"; cyclesDoneEl.textContent="0"; speechSynthesis.cancel(); if(wakeLock){ try{ wakeLock.release(); }catch(e){} } }
startBtn.addEventListener('click', start); pauseBtn.addEventListener('click', pause); resetBtn.addEventListener('click', reset);
if(speechSynthesis.onvoiceschanged!==undefined){ speechSynthesis.onvoiceschanged=()=>{}; }
</script>
</body>
</html>
